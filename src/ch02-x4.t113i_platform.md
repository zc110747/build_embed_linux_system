# 附录四:创龙TLT113-i平台SDK操作和移植说明

T113_i是全志的低端双核Cortex-A7处理，启动支持SPL模式，完整固件由SPL-Boot, Boot, Kernel, Rootfs(buildroot, ubuntu, openwrt等)组成，这里以Tronlong提供的，再全志SDK上定制的SDK为基础，关于目录的功能如下所示。

- brandy 主要包含SPL-Uboot和U-boot的源码，其中SPL以大部分代码以静态库的方式提供。
  - spl-pub 主要为SPL-UBoot实现，其中board/t113_i里面包含平台相关的静态库，用于链接
  - tools U-Boot的需要的编译和生成工具
  - **u-boot-2018** U-Boot的源码，编译生成需要的U-Boot
- build 编译需要的环境变量，编译工具和处理工具，不需要修改
- **buildroot** 编译bulidroot文件系统源码的目录，用于生成文件系统
- **device** 定义设备平台的配置信息
  - device/config/chips/t113_i/configs/tlt113-minievm-emmc/ 目录定义选择平台的信息，其中longgan/env.cfg定义u-boot的变量信息
- **kernel** 定义平台支持的内核代码
- **out** 编译输出的目录，保存输出的各二进制文件
- platform 一些支持SDK工作的平台文件，不需要修改
- rtos-dsp 用于rtos-dsp工作的相关文件
- test  用于测试系统工作的脚本和程序
- tools 支持SDK工作的工具，包含Linux和Windows平台，有编译，下载和烧录等

基于创龙TLT113-i平台的操作方法

```shell
# 配置环境配置
source ./build/envsetup.sh

# 配置编译环境
./build.sh config

# 编译所有选项
./build.sh

# 编译spl和u-boot
./build.sh brandy

# 编译内核
./build.sh kernel

# 文件系统编译
./build.sh buildroot

# 打包生成最终文件
./build.sh pack
```

firmware的结构如下所示。

| 固件名称 | 固件说明 | 来源 |
| --- | --- | --- |
| boot0_scard_sun8iw20p1.bin | SPL镜像, 用于完成必要的驱动初始化动作 | brandy/brandy-2.0/spl-pub |
|

## buildroot_compiler

- 对应ubuntu 22.04平台，早期版本不一定有这些问题

- libfakeroot.c:100:42: error: '_STAT_VER' undeclared (first use in this function)

```c
//"T113-i_v1.0/out/t113_i/tlt113-minievm-emmc/longan/buildroot/build/host-fakeroot-1.20.2/libfakeroot.c"
#ifndef _STAT_VER
 #if defined (__aarch64__)
  #define _STAT_VER 0
 #elif defined (__x86_64__)
  #define _STAT_VER 1
 #else
  #define _STAT_VER 3
 #endif
#endif
```

- missing binary operator before token "("55 | #elif HAVE_LIBSIGSEGV && SIGSTKSZ < 16384

```c
//"T113-i_v1.0/out/t113_i/tlt113-minievm-emmc/longan/buildroot/build/host-m4-1.4.18/lib/c-stack.c"

注释掉
// #elif HAVE_LIBSIGSEGV && SIGSTKSZ < 16384
// /* libsigsegv 2.6 through 2.8 have a bug where some architectures use
//    more than the Linux default of an 8k alternate stack when deciding
//    if a fault was caused by stack overflow.  */
// # undef SIGSTKSZ
// # define SIGSTKSZ 16384
```

- gdbusmessage.c:2702:30: error: '%s' directive argument is null

```c
//T113-i_v1.0/out/t113_i/tlt113-minievm-emmc/longan/buildroot/build/host-libglib2-2.56.3/gio/
//gdbusmessage.c
tupled_signature_str = g_strdup_printf ("(%s)", signature_str==NULL?"":signature_str);

//gdbusauth.c
debug_print ("SERVER: WaitingForBegin, read '%s'", line==NULL?"":line);
```

- T113-i_v1.0/out/t113_i/tlt113-minievm-emmc/longan/buildroot/build/host-dtc-1.4.7

```c
//dtc-lexer.lex.c
extern YYLTYPE yylloc;
```

- controller-enumtypes.c:7:1: error: stray '\' in program

```c
//T113-i_v1.0/out/t113_i/tlt113-minievm-emmc/longan/buildroot/build/gstreamer1-1.14.4/libs/gst/controller/controller-enumtypes.c
//T113-i_v1.0/out/t113_i/tlt113-minievm-emmc/longan/buildroot/build/gst1-plugins-base-1.14.4/gst-libs/gst/video/video-enumtypes.c
//T113-i_v1.0/out/t113_i/tlt113-minievm-emmc/longan/buildroot/build/gst1-plugins-base-1.14.4/gst-libs/gst/tag/tag-enumtypes.c
//T113-i_v1.0/out/t113_i/tlt113-minievm-emmc/longan/buildroot/build/gst1-plugins-base-1.14.4/gst-libs/gst/app/app-enumtypes.c
//T113-i_v1.0/out/t113_i/tlt113-minievm-emmc/longan/buildroot/build/gst1-plugins-base-1.14.4/gst-libs/gst/audio/audio-enumtypes.c
//T113-i_v1.0/out/t113_i/tlt113-minievm-emmc/longan/buildroot/build/gst1-plugins-base-1.14.4/gst-libs/gst/rtp/gstrtp-enumtypes.c
//T113-i_v1.0/out/t113_i/tlt113-minievm-emmc/longan/buildroot/build/gst1-plugins-base-1.14.4/gst-libs/gst/rtsp/gstrtsp-enumtypes.c
//T113-i_v1.0/out/t113_i/tlt113-minievm-emmc/longan/buildroot/build/gst1-plugins-base-1.14.4/gst-libs/gst/pbutils/pbutils-enumtypes.c
//T113-i_v1.0/out/t113_i/tlt113-minievm-emmc/longan/buildroot/build/gst1-plugins-bad-1.14.4/gst-libs/gst/mpegts/gstmpegts-enumtypes.c
//T113-i_v1.0/out/t113_i/tlt113-minievm-emmc/longan/buildroot/build/gst1-plugins-bad-1.14.4/gst-libs/gst/interfaces/photography-enumtypes.c
//T113-i_v1.0/out/t113_i/tlt113-minievm-emmc/longan/buildroot/build/gst1-plugins-bad-1.14.4/gst-libs/gst/webrtc/webrtc-enumtypes.c
//T113-i_v1.0/out/t113_i/tlt113-minievm-emmc/longan/buildroot/build/gst1-plugins-bad-1.14.4/ext/srtp/gstsrtp-enumtypes.c
\#include "gstinterpolationcontrolsource.h"  => #include "gstinterpolationcontrolsource.h"
```

- ./mkerrcodes.awk:88: warning: regexp escape sequence `\#' is not a known regexp operator

```c
//T113-i_v1.0/out/t113_i/tlt113-minievm-emmc/longan/buildroot/build/libgpg-error-1.33/src

//mkerrcodes.awk
//mkerrcodes1.awk
//mkerrcodes2.awk
//mkerrnos.awk
//mkstrtable.awk
sub (/\#.+/, ""); => sub (/#.+/, "");

//Makefile
//Makefile.am
//Makefile.in
//mkstrtable.awk
namespace => pkg_namespace
```

## 驱动文件说明

### TWI模块

TWI （Two Wire Interface）提供了CPU和任何通过TWI总线连接的兼容TWI总线的设备之间的接口。TWI被设计成与标准I2C总线协议兼容。

设备树节点:

```c
//上层，定义子节点都是2个位
// #address-cells = <2>;                   
// #size-cells = <2>;  

twi2: twi@2502800{
    #address-cells = <1>;                           //定义描述子节点寄存器地址的数目，为1个
    #size-cells = <0>;                              //定义描述子节点寄存器范围的数目，不存在
    compatible = "allwinner,sun8i-twi";             //标签位，用于twi驱动匹配
    device_type = "twi2";                           //设备类型twi2
    reg = <0x0 0x02502800 0x0 0x400>;               //twi2寄存器地址<寄存器高位 寄存器低位 寄存器范围高位 寄存器范围低位>
    interrupts = <GIC_SPI 11 IRQ_TYPE_LEVEL_HIGH>;  //twi2中断处理 <所属中断，中断线号，中断类型>
    clocks = <&ccu CLK_BUS_I2C2>;                   //twi2使能时钟，devm_clk_get
    resets = <&ccu RST_BUS_I2C2>;                   //twi2复位时钟，devm_reset_control_get
    clock-names = "bus";                            //twi2使能时钟别名，用于驱动中访问获取
    clock-frequency = <100000>;                     //twi2的clk时钟频率
    status = "disabled";                            //twi2的状态，关闭
};

//pinctrl引脚配置
//详细配置参考kernel/linux-5.4/driver/pinctrl/sunxi/
&pio {
    //...
    twi2_pins_a: twi2@0 {
        pins = "PE12", "PE13";                      
        function = "twi2";
        drive-strength = <10>;
    };

    twi2_pins_b: twi2@1 {
        pins = "PE12", "PE13";
        function = "gpio_in";
    };
}


&twi2 {
    clock-frequency = <100000>;                     //twi2的clk时钟频率
    pinctrl-0 = <&twi2_pins_a>;                     //默认的twi2的引脚复用配置，i2c模式
    pinctrl-1 = <&twi2_pins_b>;                     //休眠模式下的引脚复用配置，I/O输入模式
    pinctrl-names = "default", "sleep";             //pinctrl选项名称，用于驱动中使用
    twi_drv_used = <1>;                             //是否启动dma访问
    dmas = <&dma 45>, <&dma 45>;                    //dmas对应线号定义
    dma-names = "tx", "rx";                         //dma名称，tx, rx
    status = "okay";                                //模块状态    

    rtc@68 {
        compatible = "dallas,ds1307";               //rtc标签，用于驱动匹配
        reg = <0x68>;                               //rtc寄存器说明，0x68表示i2c器件地址
    };
};
```

配置选项: CONFIG_RTC_DRV_DS1307

文档相关: T113-i_User_Manual_V1.4 - 9.3 SPI

源码:

- kernel/linux-5.4/drivers/i2c/busses/i2c-sunxi.c
- kernel/linux-5.4/drivers/rtc/rtc-ds1307.c

相关功能: i2c接口，rtc子系统

### UART模块

通用异步接收发射机（UART）提供与外部设备、调制解调器（数据载波设备，DCE）的异步串行通信。

设备树节点:

```c
uart0: uart@2500000 {
    compatible = "allwinner,sun8i-uart";
    device_type = "uart0";
    reg = <0x0 0x02500000 0x0 0x400>;
    interrupts = <GIC_SPI 2 IRQ_TYPE_LEVEL_HIGH>;
    sunxi,uart-fifosize = <64>;
    clocks = <&ccu CLK_BUS_UART0>;
    clock-names = "uart0";
    resets = <&ccu RST_BUS_UART0>;
    uart0_port = <0>;
    uart0_type = <2>;
    status = "disabled";
};

&uart0 {
    pinctrl-names = "default", "sleep";
    pinctrl-0 = <&uart0_pins_a>;
    pinctrl-1 = <&uart0_pins_b>;
    status = "okay";
};
```

配置选项: CONFIG_SERIAL_SUNXI

文档相关: T113-i_User_Manual_V1.4 - 9.2 UART

源码: kernel/linux-5.4/drivers/tty/serial/sunxi-uart.c

相关功能: uart接口

### SPI模块

串行外设接口（SPI）是CPU和符合SPI的外部设备之间的全双工、同步、四线串行通信接口。

设备树节点:

```c
spi0: spi@4025000 {
    #address-cells = <1>;
    #size-cells = <0>;
    compatible = "allwinner,sun8i-spi";
    device_type = "spi0";
    reg = <0x0 0x04025000 0x0 0x1000>;
    interrupts = <GIC_SPI 15 IRQ_TYPE_LEVEL_HIGH>;
    clocks = <&ccu CLK_PLL_PERIPH0>, <&ccu CLK_SPI0>, <&ccu CLK_BUS_SPI0>;
    clock-names = "pll", "mod", "bus";
    resets = <&ccu RST_BUS_SPI0>;
    clock-frequency = <100000000>;
    spi0_cs_number = <1>;
    spi0_cs_bitmap = <1>;
    dmas = <&dma 22>, <&dma 22>;
    dma-names = "tx", "rx";
    status = "disabled";
};

&spi0 {
    clock-frequency = <100000000>;
    pinctrl-0 = <&spi0_pins_a &spi0_pins_b>;
    pinctrl-1 = <&spi0_pins_c>;
    pinctrl-names = "default", "sleep";
    /*spi-supply = <&reg_dcdc1>;*/
    spi_slave_mode = <0>;
    spi0_cs_number = <1>;
        spi0_cs_bitmap = <1>;
    status = "disabled";

    spi-nand@0 {
        compatible = "spi-nand";
        spi-max-frequency=<80000000>;
        reg = <0x0>;
        spi-rx-bus-width=<0x04>;
        spi-tx-bus-width=<0x04>;
        status="okay";
    };
};
```

配置选项 -

文档相关: T113-i_User_Manual_V1.4 - 9.3 SPI

源码: kernel/linux-5.4/drivers/spi/spi-sunxi.c，kernel/linux-5.4/drivers/mtd/awnand/spinand/sunxi-core.c

设备类型: spi接口，mtd设备

### GPADC模块

gpadc是12bit分辨率，8位采集精度的模数转换模块，其中channel0支持用于KEY读取。

设备树节点:

```c
gpadc: gpadc@2009000 {
    compatible = "allwinner,sunxi-gpadc";
    reg = <0x0 0x02009000 0x0 0x400>;
    interrupts = <GIC_SPI 57 IRQ_TYPE_LEVEL_HIGH>;
    clocks = <&ccu CLK_BUS_GPADC>;
    clock-names = "bus";
    resets = <&ccu RST_BUS_GPADC>;
    status = "okay";
};
```

文档相关: T113-i_User_Manual_V1.4 - 9.8 GPADC

源码: kernel/linux-5.4/drivers/input/sensor/sunxi_gpadc.c

设备类型: input子系统，/dev/event/eventX，

### TPADC模块

触摸面板ADC（TPADC）是一种4线电阻式触摸屏控制器，包括一个12位逐次逼近型A/D转换器。

设备树节点:

```c
rtp:rtp@2009c00 {
    compatible = "allwinner,sun8i-ts";
    reg = <0x0 0x02009c00 0x0 0x400>;
    clocks = <&ccu CLK_TPADC>, <&ccu CLK_BUS_TPADC>;
    clock-names = "mod", "bus";
    clock-frequency = <1000000>;
    resets = <&ccu RST_BUS_TPADC>;
    interrupts = <GIC_SPI 62 IRQ_TYPE_LEVEL_HIGH>;
};
```

配置选项: CONFIG_TOUCHSCREEN_SUNXI

文档相关: T113-i_User_Manual_V1.4 - 9.9 TPADC

源码: kernel/linux-5.4/drivers/input/touchscreen/sunxi-ts.c

设备类型: /dev/event/eventX，iput子系统

### LRADC模块

低速率模数转换器（LRADC）可以将外界信号转换成一定比例的数字值，实现对模拟信号的测量，可应用于功率检测和按键检测。

设备树节点:

```c
keyboard0: keyboard@2009800 {
    compatible = "allwinner,keyboard_1350mv";
    reg = <0x0 0x02009800 0x0 0x400>;
    interrupts = <GIC_SPI 61 IRQ_TYPE_EDGE_RISING>;
    clocks = <&ccu CLK_BUS_LRADC>;
    clock-names = "mclk";
    resets = <&ccu RST_BUS_LRADC>;
    key_cnt = <5>;
    key0 = <210 115>;
    key1 = <410 114>;
    key2 = <590 139>;
    key3 = <750 28>;
    key4 = <880 172>;
    wakeup-source;
    status = "okay";
};
/* LRADC KEY */
&keyboard0 {
    key_cnt = <1>;
    key0 = <210 148>; /* <Voltage mV> <KEY_PROG1>*/
};
```

配置选项: CONFIG_KEYBOARD_SUNXI

文档相关: T113-i_User_Manual_V1.4 - 9.10 LRADC

源码: kernel/linux-5.4/drivers/input/keyboard/sunxi-keyboard.c

设备类型: iput子系统，/dev/event/eventX

### PWM模块

脉冲宽度调制（PWM）模块可以输出可配置的PWM波形和测量外部输入的aefrm。

设备树节点:

```c
pwm7: pwm7@2000c17 {
    compatible = "allwinner,sunxi-pwm7";
    pinctrl-names = "active", "sleep";
    reg = <0x0 0x02000c17 0x0 0x4>;
    reg_base = <0x02000c00>;
};

&pwm7 {
    pinctrl-names = "active", "sleep";
    pinctrl-0 = <&pwm7_pin_a>;
    pinctrl-1 = <&pwm7_pin_b>;
    status = "okay";
};
```

配置选项: CONFIG_PWM_SUN4I

文档相关: T113-i_User_Manual_V1.4 - 9.11 PWM

源码: kernel/linux-5.4/drivers/pwm/pwm-sun4i.c

设备类型: pwm框架

### RTC模块

实时时钟（Real Time Clock， RTC）用于实现时间计数器和定时唤醒功能。

设备树节点:

```c
rtc: rtc@7090000 {
    compatible = "allwinner,sun8iw20-rtc";
    device_type = "rtc";
    wakeup-source;
    reg = <0x0 0x07090000 0x0 0x320>;
    interrupts = <GIC_SPI 144 IRQ_TYPE_LEVEL_HIGH>;
    clocks = <&r_ccu CLK_R_AHB_BUS_RTC>, <&rtc_ccu CLK_RTC_1K>, <&rtc_ccu CLK_RTC_SPI>;
    clock-names = "r-ahb-rtc", "rtc-1k", "rtc-spi";
    resets = <&r_ccu RST_R_AHB_BUS_RTC>;
    gpr_cur_pos = <6>;
};
```

配置选项: CONFIG_RTC_DRV_SUNXI

文档相关: T113-i_User_Manual_V1.4 - 3.16 RTC

源码: kernel/linux-5.4/drivers/rtc/rtc-sunxi.c

设备类型: rtc子系统

### CAN模块

CAN（控制器局域网）模块支持BoSCH CAN总线规范2.0中定义的CAN 2.0 a /B协议。CAN在CPUX中，R-CAN在CPUS中。

设备树节点:

```c
can0: can@0x0 {
    #address-cells = <1>;
    #size-cells = <0>;
    compatible = "allwinner,sun8i-can";
    pinctrl-names = "default";
    pinctrl-0 = <&can0_pins>;
    device_type = "can0";
    id = <0>;
    status = "disabled";
};
```

配置选项: CONFIG_RTC_DRV_DS1307

文档相关: T113-i_User_Manual_V1.4 - 9.16 CAN

源码: kernel/linux-5.4/drivers/net/can/sunxi_can.c

相关功能: can接口，net子系统

### SID模块

SID 提供的功能可以分为四大部分：ChipID、SoC Version、 Efuse功能、一些状态位。

设备树节点:

```c
sid@3006000 {
    compatible = "allwinner,sun8iw20p1-sid", "allwinner,sunxi-sid";
    reg = <0x0 0x03006000 0 0x1000>;
    #address-cells = <1>;
    #size-cells = <1>;

    secure_status {
        reg = <0x0 0>;         
        offset = <0xa0>;
        size = <0x4>;
    };

    chipid {
        reg = <0x0 0>;
        offset = <0x200>;
        size = <0x10>;
    };

    rotpk {
        reg = <0x0 0>;
        offset = <0x140>;
        size = <0x4>;
    };

    speedbin_efuse: speedbin@00 {
        reg = <0x00 4>;
    };

    cpubin_efuse: cpubin@28 {
        reg = <0x28 4>;
    };

    ths_calib: calib@14 {
        reg = <0x14 8>;
    };
};
```

配置选项: CONFIG_NVMEM_SUNXI_SID

文档相关: -

源码: kernel/linux-5.4/drivers/nvmem/sunxi_sid.c

设备类型: nvmem子系统

### EMAC模块

EMAC （Ethernet Medium Access Controller）是一种以太网介质访问控制器，它使主机能够在符合IEEE 802.3-2002标准的以太网上传输和接收数据。支持全双工和半双工模式下的10/100/1000mbit/s外部PHY与RMII/RGMII接口。

设备树节点:

```c
gmac0: eth@4500000 {
    compatible = "allwinner,sunxi-gmac";
    reg = <0x0 0x04500000 0x0 0x10000>,
            <0x0 0x03000030 0x0 0x4>;
    interrupts = <GIC_SPI 46 IRQ_TYPE_LEVEL_HIGH>;
    interrupt-names = "gmacirq";
    clocks = <&ccu CLK_BUS_EMAC0>, <&ccu CLK_EMAC0_25M>;
    clock-names = "gmac", "ephy";
    resets = <&ccu RST_BUS_EMAC0>;
    device_type = "gmac0";
    gmac-power0;
    gmac-power1;
    gmac-power2;
    status = "disabled";
};

&pio{
    //...

    gmac0_pins_a: gmac@0 {
        allwinner,pins = "PG14", "PG15", "PG4", "PG5", "PG6", "PG7", "PG12",
                    "PG3", "PG1", "PG2", "PG8", "PG9", "PG0", "PG10";
        allwinner,function = "gmac0";
        allwinner,muxsel = <4>;
        allwinner,drive = <1>;
        allwinner,pull = <1>;
    };

    gmac0_pins_b: gmac@1 {
        allwinner,pins = "PG14", "PG15", "PG4", "PG5", "PG6", "PG7", "PG12",
                    "PG3", "PG1", "PG2", "PG8", "PG9", "PG0", "PG10";
        allwinner,function = "gpio_in";
        allwinner,muxsel = <0>;
        allwinner,drive = <1>;
        allwinner,pull = <0>;
    };
}

&gmac0 {
    pinctrl-0 = <&gmac0_pins_a>;
    pinctrl-1 = <&gmac0_pins_b>;
    pinctrl-names = "default", "sleep";
    phy-mode = "rgmii";
    use_ephy25m = <0>;
    phy-rst = <&pio PG 13 GPIO_ACTIVE_LOW>;
    tx-delay = <2>;
    rx-delay = <0>;
    phy-tx-delay = <3>;
    phy-rx-delay = <0>;
    status = "okay";
};
```

配置选项: -

文档相关:  T113-i_User_Manual_V1.4 - 9.13 EMAC

源码: kernel/linux-5.4/drivers/net/ethernet/allwinner/

设备类型: nvmem子系统

## next_chapter

[返回目录](../README.md)

直接开始下一章节说明: [从移植STM32F4理解U-Boot](./ch02-x5.stm32_uboot.md)
