# 基于debain构建文件系统

基于buildroot我们已经可以快速轻松的构建可用的文件系统，不过这并不是没有缺陷，这里有两点：

1. 增加新的软件和库需要重新构建文件系统
2. 需要的软件buildroot不支持，仍然需要交叉编译

熟悉使用Linux系统的了解，提供dpkg和apt的两种安装软件的方式，可以本地安装和从服务器下载系统支持的文件，对于嵌入式来说，当然也支持，我们可以基于国内的镜像站构建可用的debain系统，具体脚本如下。

```shell
OPT_OS_VER=bookworm

sudo apt-get install debootstrap debian-archive-keyring qemu-user-static -y

run_as_client() {
    $@ > /dev/null 2>&1
}

#挂载系统目录
mount_chroot()
{
    sudo mount -t proc chproc "${NFS_PATH}"/proc
    sudo mount -t sysfs chsys "${NFS_PATH}"/sys
    sudo mount -t devtmpfs chdev "${NFS_PATH}"/dev || sudo mount --bind /dev "${NFS_PATH}"/dev
    sudo mount -t devpts chpts "${NFS_PATH}"/dev/pts
}

#移除系统目录
umount_chroot()
{
    while grep -Eq "${NFS_PATH}.*(dev|proc|sys)" /proc/mounts
    do
        sudo umount -l --recursive "${NFS_PATH}"/dev >/dev/null 2>&1
        sudo umount -l "${NFS_PATH}"/proc >/dev/null 2>&1
        sudo umount -l "${NFS_PATH}"/sys >/dev/null 2>&1
        sleep 5
    done
}

#使用debootstap完成从镜像源下载文件
if [ ! -d ${NFS_PATH}/bin/ ]; then
    sudo debootstrap --foreign --verbose  --arch=${CHIP_ARCH} ${OPT_OS_VER} ${NFS_PATH}  http://mirrors.tuna.tsinghua.edu.cn/debian/
fi

#安装qemu-*-static
sudo chmod -Rv 777 ${NFS_PATH}/usr/
cp /usr/bin/qemu-${qemu_arch}-static ${NFS_PATH}/usr/bin/
chmod +x ${NFS_PATH}/usr/bin/qemu-${qemu_arch}-static

#基于debootstrap完成后续安装
cd ${NFS_PATH}
mount_chroot
LC_ALL=C LANGUAGE=C LANG=C sudo chroot ${NFS_PATH} /debootstrap/debootstrap --second-stage --verbose
LC_ALL=C LANGUAGE=C LANG=C sudo chroot ${NFS_PATH} apt-get install vim libatomic1 -y
umount_chroot
```

通过上述步骤就可以构建完成基于debain的系统，后续可通过apt和debain安装后续的文件，功能上更丰富，不过占有资源也更多，需要根据自身硬件平台选择使用。

## next_chapter

[返回目录](./SUMMARY.md)

直接开始下一章节说明: [基于ubuntu构建文件系统](./ch02-12.rootfs_ubuntu.md)