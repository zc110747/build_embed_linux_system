# 嵌入式linux开发环境构建

对于嵌入式linux来说，开发环境是在芯片选型完成后就确定的，项目开发立项后，一般会特定开发板作为原型demo板(工业板卡厂商也会提供类似的开发板)，这时候编译环境是很少需要修改的，同时也会提供虚拟机平台，支持一站式服务。

目前比较流行的硬件平台有做Linux的教学的如韦东山，正点原子，工业界的有飞凌嵌入式，以及芯片厂商提供的验证板如I.MX6ull-evk等, 这些方案商或厂商会直接提供配置或编译好的Uboot，Kernal和Rootfs，开箱即用，只要在平台基础上做产品开发即可。此外还有树莓派，香橙派, 核桃派这类开箱即用的卡片电脑，系统使用Debain/Ubuntu/Android, 对于硬件的操作也封装成如Python访问的接口，在其上可以直接进行应用开发。嵌入式Linux的学习一定是要配合硬件平台的，因此本系列将以**正点原子的阿尔法开发板(NXP i.MX6ULL)**和**核桃派(全志H616)**作为基础平台去验证, 主要是我手里有这两块开发板，这里说下两个平台的特点。

- NXP i.MX6ULL，Cortex-A7 32位单核处理器，低端SOC，适合运行无桌面Linux系统或基于QT环境的界面开发。另外NXP开源资料丰富，适合去系统的学习嵌入式Linux系统，不过因为性能限制，可以做数据处理类应用以及局域网类少量访问的嵌入式应用，对于跑图形化系统，音视频处理性能不足，适合做C/C++应用开发。
- 全志H616, Cortex-A53 支持64位4核处理器，中高端SOC，适合运行Debain或Android11图形化系统，在平台上可以适合Python，Java(JNI)开发，适合音视频处理开发，也可以做复杂的系统应用开发。适合使用平台构建系统应用，不过国内系统开源不足，不利于去学习嵌入式Linux系统。

上述两个平台可以说是比较典型的支持嵌入式Linux芯片，可以满足大部分的嵌入式Linux应用，这也是我去购买使用这两块开发板的重要原因，虽然这两块开发板都提供了系统平台，但因为教程时间原因，并不统一，所以本系列将以目前的最新LTS版本Ubuntu 22.04 LTS作为开发环境(当然这个版本也会落后，不过很多思想是相通的)，每个版本遇到的问题可能也不一致，这就是Linux系统的通病，当然也是开发者的价值所在。

在嵌入式系统学习的过程中，开发环境构建是有门槛的，**不建议入门过程中在开发环境构建以及芯片bringup花费大量时间**，以我的经历来说，能够熟练构建工作环境和芯片的启动工作，在整个嵌入式Linux系统学习中也属于比较困难的部分；在我看来，很多方案商和开发各类派的厂商(如树莓派)，其最核心部分其实就是**在芯片厂商的方案基础上，基于自己设计的硬件平台提供一套开发环境和启动方案，并在其上提供技术文档和技术支持服务**；这部分可以说是很多方案商赖以生存的核心技术，知道这部分的重要性了吧，但我还是不建议在入门时就扎入这个深坑。这部分的学，基本感受不到嵌入式Linux学习的任何趣味，给我最大的感觉就是挫败感。我是自己摸索着进行学习的，在学习时感受最大的只知道跟着教程敲命令，回过头来这样并没有不好，可是当你虽然使用相同版本的系统，却因为缺少某个库文件而执行脚本失败后，因为不知道背后的背景和原理，只能去搜索相似的问题，看有没有解决办法，在最初的学习过程中，因为一遍遍的搜索浪费了大量时间，很多时候转眼3-4个小时就过去了，却没有得到好的效果，直到我如今我才慢慢总结了一套经验，下面分享一下。

1. 对于Linux某些工具，最简单的是通过apt-get安装，可通过**apt --names-only search [package]**从系统库中查找，在通过apt-get install安装。
2. 如果系统库中不存在或者版本过低, 不满足需求，可以去相应软件官网下载.deb包，使用sudo dpkg -i [package].deb安装。当然有些官网不提供deb包，但是提供编译好的二进制包，解压就可以使用，如node，选择对应指令集的二进制包，解压在使用ln命令链接到/usr/bin目录即可，当然使用最新的二进制包，如果系统版本较低，可能面临libc或libcxx库不支持的问题，可能就需要提供更新的库为软件支持。**PS:如果软件依赖更新的libc相关库，不能直接替换系统的库，通过使用更新的系统或者重新编译软件来支持，因为libc在更新会废弃部分API，导致系统命令出现兼容性问题。**
3. 上述两个都不存在，对于Linux系统，软件基本都提供源码包，这时大部分情况下就需要使用make命令进行自己编译。那么此时遇到的问题就五花八门，gcc，python版本不符合，缺少某些头文件，链接时缺少某些库文件，有些编译链接都没问题，执行时又缺少某些环境出错，或者因为编译选项问题，不支持某些需要的功能。总结下来，可以说，在软件能够正常执行前，是很难确定哪一步会出问题，回想学习嵌入式Linux的过程，在这一步浪费了最多的时间，印象深刻。在**ch01-04**章节中将会从原理上说明这类问题，也让后来者更容易去学习。

上面说明嵌入式Linux开发环境构建的背景和软件安装的方法，这当然需要一定的基础，包含不限于如下所示。

- 掌握shell命令和语法
- 系统，软件配置文件的更新规则
- 编译器，库和软件安装方法

对于构建Linux系统平台，没有一定的基础去修改是比较困难，如果错误的使用root权限去修改系统配置，是有几率导致系统功能失效，甚至直接崩溃无法启动，严重的还需要重新安装，当然我也一样经历多番波折。这部分很杂乱，没有任何教程能覆盖到所有的内容，不提Linux本身的命令，还有一些扩展应用如ssh，opencv，python，node，sqlite，tftp服务，每个软件都有一套命令机制和配置方法，单纯去学习意义不大，而且如果更换了系统版本，对于同一个软件也可能遇到不同的问题，因此这部分不适合专门去学习，而应该日常使用中总结应用，这也是整个第一章的价值所在。对于初步接触嵌入式Linux平台开发的使用者，建议还是使用开发板或者芯片厂商提供的编译脚本和环境。如果进一步深入，希望了解这个环境时如何构建的，这篇文章则从安装Ubuntu,到完成编译系统构建，以及开发中编译，安装库或者软件包的全过程，也会包含遇到的问题和解决办法，当然每个系统版本遇到的问题都可能不一样，如果遇到解决不了的，可以去浏览器搜索查找有没有人遇到类似问题或者直接跳过，甚至使用已经构建好的平台也没什么问题，不要再起步时过于纠结，兴趣才是第一老师，避免过多的挫败感打击学习的积极性。

目录

- [Linux平台系统安装](#linux_system_install)
- [Linux平台系统构建](#linux_env_struct)
- [使用WSL2系统构建Linux应用](#use_wsl2_linux)

## linux_system_install

### 选择安装环境和系统版本，并安装

安装环境可以选择虚拟机模式和直接系统安装，不过因为我习惯windows下开发，所以使用虚拟机安装，直接系统安装可用UltraISO制作系统盘安装，这里平台选择如下.

- VMvare 15.5.7/WSL2
- Ubuntu22.04 LTS, 地址:<https://mirrors.tuna.tsinghua.edu.cn/ubuntu-releases/22.04/>

选择>新建虚拟机>典型, 选择安装文件*.iso，直接下一步安装，等待完成即可.

### 修改镜像源，完善系统环境

如果安装完成的ubuntu无法访问网络环境，通过修改支持国内的dns服务器.

```shell
sudo vi /etc/resolv.conf

#添加如下代码
nameserver 223.5.5.5
nameserver 8.8.8.8
nameserver 8.8.4.4
```

Ubuntu默认使用的镜像源在国外，直接下载访问比较慢，大部分都会直接失败，所以我一般会更新使用国内源，我目前使用的是国内清华镜像源。

- <https://mirrors.tuna.tsinghua.edu.cn/help/ubuntu/>

按照网页说明选择对应版本，替换/etc/apt/sources.list下文件，然后执行如下命令即可.

```shell
sudo apt-get update
sudo apt-get upgrade
```

如果出现Ign0:xxxxxxx的访问错误，这是表示访问失败，**需要选择http版本**。构建完成后，需要安装编译支持的脚本或者库，下面提供了一些在编译驱动，内核还有编译一些第三方时遇到后遇到的需要增加和更新的库，可酌情安装，后续遇到问题我也会同步更新在下面.

```shell
sudo apt-get install vim lib32z1 cmake -y
sudo apt-get install bc lzop libffi-dev libssl-dev lzop git -y
sudo apt-get install libncurses5-dev u-boot-tools openssh-server -y 
sudo apt-get install dos2unix gzip libtool flex -y
sudo apt-get install build-essential manpages-dev make bison -y
sudo apt-get install software-properties-common binutils gcc-multilib -y 
sudo apt-get install libc6-dev-i386 net-tools -y
sudo apt-get install lsb-core lib32stdc++6 -y
```

如此，基本完成了linux平台基础环境的构建.

## linux_env_struct

对于Linux平台环境的构建，包含熟悉Linux平台命令和文件知识，安装方便使用和开发的工具，能够自己编译或交叉编译些库和程序，这部分工作并不困难，却十分复杂，不同系统(centos, ubuntu)，相同系统的不同版本(16.04, 22.04),甚至相同版本系统下不同的库支持情况，都会面临不同的问题，这部分不建议机械的学习，而是有概念后，在使用Linux的过程中，积累深入总结，当你能够整理出自己的笔记或者能实现自己的一键构建工具后，也就自然学会掌握了。

### 交叉编译环境构建

对于嵌入式linux，第一步就是下载交叉编译工具，例如我使用的imx6ull芯片，可以访问如下网站获取编译工具。

- <https://releases.linaro.org/components/toolchain/binaries/7.5-2019.12/arm-linux-gnueabihf/>

下载最新的编译工具，如我使用的是*gcc-linaro-7.5.0-2019.12-i686_arm-linux-gnueabihf.tar.xz*.

- 对于普通用户，可通过在/etc/profile中添加export PATH="$PATH:[diectory]"在全局环境添加.
- 对于root用户，可直接修改/etc/environment，添加到里面指定的PATH路径即可.

不过这个版本最高支持到7.5.0版本，后面就没有更新，如果使用更高版本的编译工具，需要去arm官网下载，不过速度比较慢，这里推荐去清华源镜像去下载。

- <https://mirrors.tuna.tsinghua.edu.cn/armbian-releases/_toolchain/>

这里也说下arm编译工具命名的规则，便于选择用于编译的工具, 这里列出几个不同类型的arm编译工具。

```shell
'gcc-linaro-7.5.0-2019.12-i686_arm-linux-gnueabihf.tar.xz'
'gcc-arm-11.2-2022.02-x86_64-aarch64-none-linux-gnu.tar.xz'
'gcc-arm-11.2-2022.02-x86_64-arm-none-linux-gnueabihf'
'gcc-arm-11.2-2022.02-x86_64-arm-none-eabi.tar.xz'
```

其格式如下:

- [gcc]-[提供编译工具的组织]-[gcc版本]-[生成时间]-[编译器运行平台(i686/x86_64)]-[编译目的平台(arm/aarch64)]-[none, 厂商信息]-[linux, 编译器支持环境]-[abi接口和浮点支持]

这里有几个重要知识点讲解:

- 编译器运行平台，i686为32位x86运行环境，x86_64则为64位x86运行环境.
- 编译目的平台，arm位32位arm，aarch64为64位arm，aarch64一般只有更高端的arm平台才支持如Cortex-A53等.
- none为可选厂商信息，可以省略，arm提供的一般为none.
- linux表示编译器目的运行平台，带linux则表示为linux环境，不存在则表示用于裸机程序.
- abi接口表示支持应用开发的兼容的二进制接口，带hf则表示支持硬件浮点.

## use_wsl2_linux

对于嵌入式Linux开发，在Windows下有更方便的开发方法，那就是使用WSL2开发, 这里不推荐使用WSL1，因为WSL1使用在Windows下模拟Linux的API，虽然MicroSoft进行了相当程度的更新，但是仍然有接口和应用的缺失，如系统不支持消息队列，编译内核时缺少某些头文件和库，特别是交叉编译时会遇到各种莫名其妙的问题，而且很难找到原因。对于WSL2则完全采用Hyper-V虚拟机机制，和VMVare使用一致，另外老版本的WSL2和VMVare对于虚拟网络有兼容性问题，会导致VMVare无法启动系统，需要将VMVare升级到15.5.7版本或者更高版本，具体流程参考这篇文章:<https://www.bilibili.com/read/cv16178040/>，关于WSL2的开启和使用如下所示, 具体可参考地址:<https://learn.microsoft.com/zh-cn/windows/wsl/install>。

- 首先在UEFI(BIOS)中启动虚拟化，这个可能根据所用产品平台有关，可参考地址:<https://support.microsoft.com/zh-cn/windows/%E5%9C%A8windows-11%E7%94%B5%E8%84%91%E4%B8%8A%E5%90%AF%E7%94%A8%E8%99%9A%E6%8B%9F%E5%8C%96-c5578302-6e43-4b4b-a449-8ced115f58e1>
- 在控制面板>程序>启用或关闭Windows功能>适用于Linux的windows子系统，选中并重启，此时PowerShell中可以使用WSL命令。
- 以管理员身份启动PowerShell，执行如下命令**wsl --update**，下一步就是安装系统了，这里建议使用MicroSoft中的系统，版本为Ubuntu 22.04 LTS，安装方法也很简单，左下角打开MicroSoft Store, 搜索Ubuntu，选择Ubuntu 22.04.3 LTS，点击免费下载，完成后，点击安装，等待完成后重启即可。
- 此后，在Windows平台即可在命令行使用wsl或者直接左下角搜索Ubuntu打开Linux系统，并可以通过**wsl --set-version Ubuntu-22.04 2**来设置在wsl2运行系统，之后可以按照正常Ubuntu虚拟机进行环境构建和开发。目前wsl2的系统使用的Linux内核为Linux 5.15，后续应该版本更高，进入系统后使用uname -a可以判断是否切换成功。

注意:**wsl2虽然默认支持通过/mnt/d访问windows平台的文件，因为是通过文件系统转译的方式访问，效率很低，会大幅度增加编译时间。另外windows文件不区分大小写，所以很可能Makefile和makefile被识别为同一文件，导致关于文件处理上出错，从而有可能错误删除文件，所以使用wsl2时，文件还是移动到wsl2的Linux目录下如/home/下，可以通过vscode远程链接访问，我就踩过类似坑，要尽量避免。**

## next_chapter

[返回目录](./SUMMARY.md)

直接开始下一小节: [ch01-01.shell命令](./ch01-01.linux_shell_cmd.md)
