# 文件系统构建综述

## overview

Linux文件系统是用于管理和存储的一系列的文件的集合，按照功能上包含如下内容。

- 系统和文件管理有关的程序(ls，cat，cd, systemd等)
- 存储设备信息的文件，以及系统运行相关的设备文件(/sys, /proc等)
- 支持软件和脚本运行的环境和库(/lib/, /usr/lib)
- 控制系统启动配置和服务器的的脚本(/etc/)

对于文件系统，大都是从busybox，buildroot，复杂的可能是yocto或debain，都是讲解如何构建文件系统。可回想起来，有问题一直在困扰我，为什么使用这些工具能够构建可用的文件系统，它们实现的原理是什么，为什么按照这些的步骤就可以实现可用的文件系统，busybox，buildroot，debain等它们是否有什么联系？在理解这个问题以前，无论是构建文件系统，还是交叉编译软件，可以说迷雾重重，直到系统总结这个问题，才开始有了主动思考，分析并解决问题的能力。

不卖关子了，这里用一句话解释，**文件系统是被内核访问的，由目录和文件构成的树结构的集合体**。它设计上是为内核提供可以对外的访问接口，而在Linux中"一切皆文件的思想"指导下，这些接口又以文件的形式展示。基于这些信息，就可以将文件系统进一步解构。

1. 创建包含系统工作需要的目录(bin, dev, etc...)
2. 必须的配置文件和服务，以及权限管理机制(/etc/profile, /etc/init.d/...)
3. 运行的必要环境变量和执行程序(bash, tar...)
4. 支持上述程序或脚本运行的库(libc.so, libdrm.so...)
5. 用户安装的扩展系统功能的程序(/usr/bin/， /sbin/)。

理解了上述这些，就可以进一步去掌握文件系统各目录的功能，具体如下。

- bin/      **必须**，存放系统执行的必备二进制工具，用于系统启动和快速访问，如bash，cp，mkdir等
- boot/     启动目录，存放启动文件，可在系统启动时加载执行，可以不存在
- dev/      **必须**，包含了与硬件设备相关的特殊文件。dev目录下的文件在系统启动时由内核自动创建，这些文件是系统提供的访问内核硬件的接口文件，用于与硬件设备、驱动程序以及其他内核的数据交互。
- etc/      **必须**，系统配置文件目录，用于管理系统启动配置项和服务项，如启动脚本，系统服务，网络配置
  - etc/fstab 定义文件系统的静态信息的文件。它包含了系统中硬盘分区、挂载点、文件系统类型、挂载选项等信息，用于指导系统如何挂载文件系统.
  - etc/hosts 包含了本机或其他主机的IP地址和对应的主机名，以及主机名的别名.
  - etc/passwd 包含用户信息的文件，如用户名，权限以及启动后执行的脚本命令.
  - etc/shadow etc/passwd的影子口令文件，用户密码信息存放在此处，root权限可读
  - etc/init.d/rc* 启动、或改变运行集执行的脚本文件
- home      根目录，通过adduser创建的自定义用户目录位于此目录下，一般仅特定用户支持的文件和工具也安装在此
- lib/      **必须**，用于存放系统所需的共享库文件的目录。这些库文件包含了程序运行时所需要的函数和数据，以便程序能够正确地执行。
- media/    可选，用于挂载可移动存储设备的目录，提供方便，统一的挂载点。
- mnt/      可选，mnt目录是一个挂载点，用于临时挂载文件系统。它通常用于挂载外部存储设备或网络文件系统，以便用户可以轻松地访问和操作这些文件系统
- opt/      可选，用于存放独立的第三方软件包，这些软件包通常不是操作系统的核心组件，提供可选的安装目录。
- proc/     **必须**，和/dev/类似，不过与设备不同，这里提供应用层操作内核配置和参数的接口(包括硬件)，使得用户和应用程序可以通过/proc来查看有关系统硬件、当前正在运行进程的信息，甚至可以更改其中某些文件来改变内核的运行状态。
- root/     **必须**，root用户的工作目录，存储root用户的个人文件和配置信息。
- run/      可选，是一个临时文件目录，用于存储系统启动以来的信息，重启后，系统会自动删除相关信息。
- sbin/     **必须**，主要放置了一些系统管理的必备程序。
- srv/      服务目录，存放本地服务的相关文件
- sys/      **必须**，虚拟文件系统目录，也称为sysfs，它提供了对内核对象和设备树的访问。
- tmp/      **必须**，临时文件存储目录，其作用是为应用程序和用户提供公共的临时文件存储空间，重启后会清除tmp缓存信息。
- usr/      **必须**，用户安装的软件和文件，以及系统默认的软件和文件，包含了系统的核心文件和应用程序。
- var/      可选，包含了在系统运行过程中会改变的文件，这些文件通常包括日志文件、临时文件和缓存文件。

关于rootfs目录的标准定义参考网址: <http://www.pathname.com/fhs>

文件系统的构建过程，就是创建上述目录，并在对应目录下保存相应文件，库或者程序的过程。而上面提到的构建过程都是实现这个目录，理解了文件系统的本质，那么构建系统和交叉编译的问题就有另外的思路去理解。

构建系统的步骤可以分为如下:

1. 创建系统启动的目录(包含上面的**必须**目录)
2. 复制写入系统启动必须的动态库，放置在lib目录
3. 创建系统执行的必要配置和服务，这个在etc目录
4. 安装系统启动的必要命令工具，如bash(sh), cp, ls等，放置在bin, sbin目录

至此，一个基于命令行的，可以远程访问的最小Linux文件系统构建完成，Busybox的构建就是基于此逻辑。不过这样构建的系统只支持基本的Linux功能，如etc启动配置，shell命令(ls, cd，mv)，如果想支持更多的功能，就需要去找源码单独编译移植，然后将动态库和程序安装到相应的目录中，前面的交叉编译就是讲述了这个过程，这也是嵌入式Linux平台的常见操作。

基于Busybox的系统构建仅提供必要的命令工具和文件，对于系统中需要的目录，动态库和配置文件都需要手动创建或添加，当然这种方式会十分麻烦，而且容易出错。为了解决Busybox手动安装复杂的问题，就有项目通过脚本工具链，以类似Busybox这类文件系统为基础，集合Linux平台常用工具，配合界面化的管理方案，实现通过配置搭配命令的方式直接生成打包完成的文件系统，这就是buildroot项目的设计原理。当然buildroot项目支持更加全面，不仅包含以busybox，systemd的基础系统，还支持添加python，lua等软件，通过menuconfig菜单和.config管理，兼顾了自动化构建和可裁剪系统的优点，对于较低性能的嵌入式SOC应用是首先选择。

Buildroot是通用的方案，如果应用需要很多配置项的调整，这也是一大难点。因此部分厂商参考这个思路，根据自家平台进一步整理个性化，包含私有的配置，然后打包以SDK形式发布，允许用户编译使用，这就是yocto文件系统。

Openwrt的原理和Buildroot类似，也是生成定制Linux系统的工具集和框架，不过其偏向于软路由实现，自带集成网络管理和远程Web控制，其内部也集成下载工具，支持通过opkg安装离线和本地软件，是为路由应用专门定制的一款的系统。

Busybox，Buildroot，Yocto和Openwrt这些文件系统的构建都涉及到环境构建和编译，这不仅需要很长时间，而且文件系统的编译也十分依赖文件的支持，需要耗费大量的时间经理。参考文件系统是文件和目录的集合，那么有没有把所有文件压缩成压缩包，用户只需要下载解压，执行安装既可以生成，不需要编译就可以构建系统，当然存在，Debain文件系统就是基于此方法构建的(Ubuntu属于Debain的进一步整合，所以实现类似)。当然还有其它的文件系统，如安卓等，虽然构建方式不同，但也没有摆脱这几种方式；理解了这些，就可以更清晰的构建文件系统。

本节目录如下.

- [基于busybox构建文件系统](./ch02-09.rootfs_busybox.md)
- [基于buildroot构建文件系统](./ch02-10.rootfs_buildroot.md)
- [基于Debain构建文件系统](./ch02-11.rootfs_debain.md)
- [基于Ubuntu Core构建文件系统](./ch02-12.rootfs_ubuntu.md)
- [支持QT的Linux文件系统构建](./ch02-13.rootfs_qtsupport.md)
- [基于openwrt构建文件系统](./ch02-14.rootfs_openwrt.md)
- [基于安卓构建文件系统](./ch02-15.android_sdk.md)

## next_chapter

[返回目录](../README.md)

直接开始下一章节说明: [基于busybox构建文件系统](./ch02-09.rootfs_busybox.md)
