# 基于buildroot构建文件系统

buildroot就是以busybox为核心，支持编译工具，库，可执行文件和服务的，用于Linux文件系统构建的自动化脚本工具。当然对于buildroot新版本，也增加了对uboot和kernel的支持，不过这里不进行添加，uboot和kernel下载和编译时间很长，而且buildroot支持版本是主线的分支，不一定支持用户的开发板，因此一般不使用buildroot进行编译。这里主要说明对于文件系统的编译实现，先讲解下目录中跟编译和构建息息相关的功能。

- configs/ 包含默认的配置文件，当然我们定义的配置文件也可以放置再此目录中
- dl/ 编译中需要支持的库，在编译中会下载到此目录，在国内可能下载困难，可以自己下载放置到此目录中
- ouput/ 构建好的文件系统存储目录

## 下载安装包, 并解压

```shell
#下载buildroot
wget https://buildroot.org/downloads/buildroot-2024.02.1.tar.gz
tar -xvf buildroot-2024.02.1.tar.gz
cd buildroot-2024.02.1/
```

## 配置编译脚本

buildroot的构建和uboot，kernel类似，支持默认配置文件，也支持通过菜单修改，这里使用默认配置文件导入的方式，定义文件名为configs/imx6ull_user_defconfig, 内容如下：

```shell
#更新配置文件
vim configs/imx6ullrmk_defconfig

############# imx6ullrmk_defconfig #############
# architecture
BR2_arm=y
BR2_cortex_a7=y
BR2_ARM_FPU_NEON_VFPV4=y

#
# Toolchain
#
BR2_TOOLCHAIN_EXTERNAL=y
BR2_TOOLCHAIN_EXTERNAL_CUSTOM=y
BR2_TOOLCHAIN_EXTERNAL_PREINSTALLED=y
BR2_TOOLCHAIN_EXTERNAL_PATH="/home/freedom/sdk/arm/support/compiler"
BR2_PACKAGE_PROVIDES_TOOLCHAIN_EXTERNAL="toolchain-external-custom"
BR2_TOOLCHAIN_EXTERNAL_PREFIX="arm-none-linux-gnueabihf"
BR2_TOOLCHAIN_EXTERNAL_CUSTOM_PREFIX="arm-none-linux-gnueabihf"
BR2_TOOLCHAIN_EXTERNAL_GCC_11=y
BR2_TOOLCHAIN_EXTERNAL_HEADERS_4_20=y
BR2_TOOLCHAIN_EXTERNAL_CUSTOM_GLIBC=y
BR2_TOOLCHAIN_EXTERNAL_CXX=y
BR2_TOOLCHAIN_EXTERNAL_FORTRAN=y
BR2_TOOLCHAIN_EXTERNAL_OPENMP=y
BR2_TOOLCHAIN_EXTERNAL_INET_RPC=n
BR2_TARGET_ROOTFS_EXT2_SIZE="1G"
BR2_KERNEL_MIRROR="https://mirrors.kernel.org/pub"

# system
BR2_TARGET_GENERIC_GETTY_PORT="ttymxc0"

# filesystem / image
BR2_TARGET_ROOTFS_EXT2=y
BR2_TARGET_ROOTFS_EXT2_4=y

# System configuration
BR2_TARGET_GENERIC_HOSTNAME="freedom"
BR2_TARGET_GENERIC_ISSUE="Welcome to freedom"
BR2_TARGET_GENERIC_ROOT_PASSWD="root"
```

将上述文件放置在buildroot/configs/目录下，执行编译脚本。

## 执行编译和生成文件

```shell

#生成.config文件
make menuconfig imx6ull_user_defconfig

#开始编译
make -j6
```

这一步要等待一段时间，因为会自动下载一些软件，如果位于国外，会比较慢，可以自己看命令下载放置在dl目录。等待编译完成后，output/images目录下即为编译好的虚拟硬盘文件，直接使用即可，可以直接用mount命令挂载查看。

```shell

#创建目录，并挂载文件系统
mkdir output/images/rootfs/
cd output/images
sudo mount -o loop rootfs.ext4 rootfs/
```

此时，就可以在rootfs中查看构建好的文件系统, 如果需要增加软件或者库支持，在buildroot配置项中增加相应工具即可。

## next_chapter

[返回目录](./SUMMARY.md)

直接开始下一章节说明: [基于debain构建文件系统](./ch02-11.rootfs_debain.md)
