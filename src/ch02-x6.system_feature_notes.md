# 附录六:系统问题支持

- [修改内核logo显示](#feature-001)
- [systemd增加自定义服务方法](#feature-002)
- [指定console输出接口(串口或者屏幕)](#feature-003)
- [开机启动延时一段时间执行脚本](#feature-004)
- [nfs启动显示为Read-Only FileSystem](#feature-005)

## feature-001

- 系统启动后加载的界面文件所在的目录为kernel/drivers/video/logo, 其中*.ppm格式文件就是转换需要使用得ppm文件
- 在微软商店下载GIMP，添加一张图片=>图像=>模式=>索引颜色转换=>最大颜色数量设置为(224), 设置分辨率大小，并导出
- 选择导出格式为ppm，保存格式为ASCII将转换好的图片文件拷贝到 drivers\video\logo目录下，比如：logo_user_clut224.ppm  //必须加clut224导出
- 修改Kconfig文件

```shell
vi drivers/video/logo/Kconfig

#===============================================
# ++++++
config LOGO_USER_CLUT224
        bool "Standard224-color User logo"
        default y 
#===============================================
```

- 修改Makefile文件

```shell
vi drivers/video/logo/Makefile

#===============================================
# ++++++
obj-$(CONFIG_LOGO_USER_CLUT224)  += logo_user_clut224.o
#===============================================
```

- 修改开机logo图片数据管理文件logo.c

```c
vi drivers/video/logo/logo.c

//==============================================
// ++++++
#ifdef  CONFIG_LOGO_LUO_CLUT224
    /* Generic Linux logo */
    logo = &logo_user_clut224;
#endif
//===============================================
``

- 添加头文件申明

```c
vi include/linux/linux_logo.h

//==============================================
// ++++++
extern const struct linux_logo logo_user_clut224;
//==============================================
```

- 在终端编译，在执行menuconfig时，修改内核配置选项。

```shell
DeviceDrivers  --->
  Graphics support  --->
  
Bootup logo  --->
    ---Bootup logo
    [ ] Standard black and whiteLinux logo
    [ ] Standard 16-color Linux logo
    [ ] Standard 224-color Linuxlogo
    
 Standard 224-color  hanbo logo (NEW)  （修改）
```

## feature-002

systemd增加自启动服务方法。

Systemd是目前主流的Linux启动机制，其定义一套完整的系统启动和管理的解决方案。Systemd的默认service路径为"/etc/systemd/system/"，当启动后，会在"/lib/systemd/system"目录下创建链接，实现启动时运行。Systemd的应用配合systemctrl命令，可以实现服务使能/关闭，服务启动/停止，服务状态查询等功能，service的文件格式如下所示。

```shell
cd /etc/systemd/system

sudo vim example.service
#############################################################
# [Unit]
# Description: service的简单描述
# Requires（可选）: 设置服务的强依赖性，表示当前服务启动之前必须启动的其他服务
# After（可选）：指定服务启动的顺序，表示当前服务应该在哪些服务之后启动
# Before（可选）：与After相反，指定服务启动的顺序，表示当前服务应该在哪些服务之前启动
# Wants（可选）：设置服务的弱依赖性，表示当前服务启动之后可能还需要启动的其他服务
# Conflicts（可选）：定义服务间的冲突关系，表示如果当前服务启动，则指定的服务不能启动
# [Service]
# Type：服务进程启动类型，如simple、forking、oneshot、dbus、notify和idle等
# ExecStart：指定启动服务时要运行的命令或脚本的绝对路径。
# ExecStartPre（可选）：在ExecStart之前运行的命令或脚本
# ExecStartPost（可选）：在ExecStart之后运行的命令或脚本
# ExecStop：指定停止服务时要运行的命令或脚本
# ExecReload（可选）：指定重新加载服务配置时要运行的命令或脚本
# Restart：指定服务在失败或停止时是否自动重启，以及重启的策略（如always、on-failure等）
# RestartSec（可选）：在服务重启之前等待的时间间隔
# EnvironmentFile（可选）：指定环境配置文件的路径。
# [Install]
# WantedBy：指定服务应该与哪个目标（target）一起启动，通常设置为multi-user.target，表示服务将在多用户模式下启动
# Also（可选）：指定在安装本服务时还要安装的其他相关服务
# Alias（可选）：为服务指定别名，方便使用systemctl命令进行管理
#############################################################

[Unit]
Description=Example Service
After=network.target

[Service]
ExecStart=/home/freedom/start.sh
WorkingDirectory=/tmp/
Restart=always

[Install]
WantedBy=multi-user.target
#############################################################

# 创建启动脚本
cd /home/freedom
sudo vim start.sh
#############################################################
#!/bin/bash

echo "hello start"
#############################################################
chmod 777 start.sh

# 使能服务(链接到/lib/systemd/system，启动时加载)
sudo systemctl enable example.service

# 当前启动example.service
sudo systemctl start example.service

# 查看service运行状态
systemctl status example.service
```

加载成功后，状态如下所示.

![image](./image/ch02-x6-01.png)

注意：shell脚本首行要指定使用的shell平台，例如bash脚本则为"#!/bin/bash"，否则脚本会执行失败。

## feature-003

指定console输出接口(串口或者屏幕)。

- 指定console输出kernel信息到屏幕

```shell
setenv bootargs "console=tty1 console=ttymxc0,115200 panic=5 rootwait root=/dev/mmcblk0p2 earlyprintk rw"
```

- buildroot指定console在系统中支持输出(不期望应用层输出打印，可不执行这一步)

```shell
# 修改/etc/inittab, 增加tty1
ttymxc0::respawn:/sbin/getty -L  ttymxc0 0 vt100 # GENERIC_SERIAL
tty1::respawn:/sbin/getty -L  tty1 0 vt100 # GENERIC_SERIAL, 增加显示
```

- debian，uboot指定console在系统中支持输出

```shell
# 复制串口ttymxc0启动服务，所有步骤完成
cd /etc/systemd/system/getty.target.wants

#[ TIME ] Timed out waiting for device dev-ttymxc0.device. 
# 如果是其它芯片，需要将ttymxc0更新为相应的串口，否则会失去命令行打印
cp -d getty@tty1.service getty@ttymxc0.service
```

## feature-004

开机启动延时一段时间执行。

对于busybox管理的系统，在rcS中添加后台执行的脚本。

在启动脚本中添加执行脚本。

```shell
vi  /etc/init.d/rcS

#########################################
# 添加后台启动脚本
/home/sys/shell/bringup_shell.sh &
#########################################
```

定义脚本内容，设置延时执行时间

```shell
# 修改bringup_shell.sh脚本
mkdir /home/sys/shell
vi /home/sys/shell/bringup_shell.sh

#########################################
#!/bin/sh

echo "start bash"
sleep 2s
/home/sys/start_app.sh
#########################################

# 设置脚本可执行
chmod 777 /home/sys/shell/bringup_shell.sh
```

对于debian系统，添加到系统service中。

## feature-005

nfs系统创建文件报错: can't create directory 'dir': Read-only file system.

原因: bootargs配置中缺少rw选项，需要添加。

```shell
# 更新/dev/nfs支持rw
setenv bootargs 'console=ttymxc0,115200 root=/dev/nfs rw nfsroot=192.168.1.25:[nfsdir] ip=192.168.2.34:192.168.2.29:192.168.2.1:255.255.255.0::eth0:off'

# 仅当次修改解决
mount rw -o remount /
```

## next_chapter

[返回目录](../README.md)

直接开始下一章节说明: [嵌入式Linux驱动开发](./ch03-00.driver_design.md)
